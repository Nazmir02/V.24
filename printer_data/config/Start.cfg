[gcode_macro PRINT_START]
description: Voron 2.4 + Chaoticlab TAP + Rapido UHF (clean probing, no ooze)
gcode:
    # =====================================
    # PARAMETERS FROM SLICER
    # =====================================
    {% set bed_temp = params.BED|default(params.BED_TEMP|default(60))|int %}
    {% set extruder_temp = params.EXTRUDER|default(params.EXTRUDER_TEMP|default(200))|int %}

    G90
    M83

    RESPOND MSG="Happy Printing, Amirul!"
    M117 Happy Printing, Amirul!

    # =====================================
    # HEAT BED ONLY (NO NOZZLE YET)
    # =====================================
    status_heating
    RESPOND MSG="Heating bed..."
    M140 S{bed_temp}
    M190 S{bed_temp}

    # =====================================
    # ANTI-OOZE SAFETY (RAPIDO UHF)
    # =====================================
    # Ensure zero pressure before ANY probing
    G92 E0
    G1 E-2.0 F1800

    # =====================================
    # HOMING SEQUENCE (SAFE ORDER)
    # =====================================
    status_homing
    RESPOND MSG="Homing X/Y..."
    G28 X Y

    RESPOND MSG="Homing Z with TAP..."
    G28 Z

    # Extra safety retract before QGL
    G92 E0
    G1 E-1.0 F1800

    # =====================================
    # QUAD GANTRY LEVEL
    # =====================================
    status_leveling
    RESPOND MSG="Quad Gantry Level..."
    QUAD_GANTRY_LEVEL

    # Re-home Z after QGL (mandatory for Voron)
    RESPOND MSG="Re-homing Z..."
    G28 Z

    # =====================================
    # ADAPTIVE BED MESH (KAMP)
    # =====================================
    status_leveling
    RESPOND MSG="Adaptive bed mesh..."
    BED_MESH_CLEAR
    BED_MESH_CALIBRATE ADAPTIVE=1
    G1 Z20 F3000

    # =====================================
    # HEAT NOZZLE TO PRINT TEMP
    # =====================================
    status_heating
    RESPOND MSG="Heating nozzle..."
    M104 S{extruder_temp}
    M109 S{extruder_temp}
    M400
    G4 P500

    # =====================================
    # NOZZLE CLEAN
    # =====================================
    status_cleaning
    RESPOND MSG="Cleaning nozzle..."
    CLEAN_NOZZLE

    # =====================================
    # PARK & PURGE
    # =====================================
    SMART_PARK
    RESPOND MSG="Line purge..."
    LINE_PURGE

    status_printing
